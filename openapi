openapi: 3.0.3
info:
  title: API для портала "Добрые дела Росатома"
  description: |
    RESTful API для многостраничного сайта "Добрые дела Росатома".
    Предоставляет методы для управления НКО, событиями, новостями, базой знаний и пользователями.
    API разделено на публичную часть, доступную всем, и приватную, требующую аутентификации для личного кабинета и административных функций.
  version: 1.0.0

servers:
  - url: https://api.dobro.rosatom.ru/v1
    description: Production Server

tags:
  - name: Публичные данные
    description: Эндпоинты для получения общедоступной информации (НКО, новости, события).
  - name: Аутентификация и Пользователи
    description: Регистрация, вход и управление профилем пользователя.
  - name: НКО (Некоммерческие организации)
    description: Управление данными НКО.
  - name: События (Календарь)
    description: Управление событиями.
  - name: Новости
    description: Управление новостями.
  - name: База знаний
    description: Управление материалами в базе знаний.
  - name: Администрирование
    description: Эндпоинты для модерации контента.

paths:
  # ===============================================================
  # Аутентификация и Пользователи
  # ===============================================================
  /auth/register:
    post:
      tags: [Аутентификация и Пользователи]
      summary: Регистрация нового пользователя
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
                name:
                  type: string
      responses:
        '201':
          description: Пользователь успешно создан
        '400':
          description: Некорректные данные или пользователь уже существует

  /auth/login:
    post:
      tags: [Аутентификация и Пользователи]
      summary: Аутентификация пользователя
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Успешный вход, возвращает JWT токен
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
        '401':
          description: Неверные учетные данные

  /users/me:
    get:
      tags: [Аутентификация и Пользователи]
      summary: Получить информацию о текущем пользователе (личный кабинет)
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Данные профиля пользователя
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
    put:
      tags: [Аутентификация и Пользователи]
      summary: Обновить информацию о текущем пользователе
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileUpdate'
      responses:
        '200':
          description: Профиль успешно обновлен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'

  # ===============================================================
  # Публичные данные
  # ===============================================================
  /cities:
    get:
      tags: [Публичные данные]
      summary: Получить список городов присутствия
      responses:
        '200':
          description: Список городов
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/City'

  /nko:
    get:
      tags: [Публичные данные]
      summary: Получить список НКО с фильтрацией
      description: Фильтрация по городу, категориям, избранному и regex поиску
      parameters:
        - name: jwt_token
          in: query
          required: true
          schema:
            type: string
          description: JWT токен пользователя
        - name: city
          in: query
          required: false
          schema:
            type: string
          description: Название города для фильтрации
          example: "Москва"
        - name: favorite
          in: query
          required: false
          schema:
            type: boolean
          description: Фильтр по избранным НКО
        - name: category
          in: query
          required: false
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          description: Список категорий для фильтрации (можно передать несколько раз)
          example: ["Помощь детям", "Образование"]
        - name: regex
          in: query
          required: false
          schema:
            type: string
          description: Регулярное выражение для поиска в названии и описании
          example: "инициативы"
      responses:
        '200':
          description: Список НКО
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NKOResponse'
        '500':
          description: Ошибка базы данных
    post:
      tags: [НКО (Некоммерческие организации)]
      summary: Создать новое НКО
      description: Создание нового НКО с проверкой существования города и категорий
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NKOCreateRequest'
      responses:
        '201':
          description: НКО успешно создано
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NKOResponse'
        '404':
          description: Город или категория не найдены
        '500':
          description: Ошибка базы данных

  /nko/{nkoId}:
    get:
      tags: [Публичные данные]
      summary: Получить детальную информацию об одном НКО по ID
      parameters:
        - name: nkoId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Детальная информация о НКО
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NKOResponse'
        '404':
          description: НКО не найдено
        '500':
          description: Ошибка базы данных
    delete:
      tags: [НКО (Некоммерческие организации)]
      summary: Удалить НКО по ID
      description: Удаление НКО и всех связанных с ним данных (категории)
      parameters:
        - name: nkoId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: НКО успешно удалено
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "НКО с ID 1 успешно удалено"
        '404':
          description: НКО не найдено
        '500':
          description: Ошибка базы данных

  /event:
    get:
      tags: [Публичные данные]
      summary: Получить список событий с фильтрацией
      description: Фильтрация по НКО, категориям, временному диапазону, избранному и regex поиску
      parameters:
        - name: jwt_token
          in: query
          required: true
          schema:
            type: string
          description: JWT токен пользователя
        - name: nko_id
          in: query
          required: false
          schema:
            type: array
            items:
              type: integer
          style: form
          explode: true
          description: Список ID НКО для фильтрации (можно передать несколько раз)
          example: [1, 2]
        - name: favorite
          in: query
          required: false
          schema:
            type: boolean
          description: Фильтр по избранным событиям (заглушка)
        - name: category
          in: query
          required: false
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          description: Список категорий для фильтрации (можно передать несколько раз)
          example: ["Спорт", "Культура"]
        - name: regex
          in: query
          required: false
          schema:
            type: string
          description: Регулярное выражение для поиска в названии и описании
          example: "концерт"
        - name: time_from
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Фильтр по времени начала события (ISO format)
          example: "2024-01-01T00:00:00"
        - name: time_to
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Фильтр по времени окончания события (ISO format)
          example: "2024-12-31T23:59:59"
      responses:
        '200':
          description: Список событий
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/EventResponse'
        '500':
          description: Ошибка базы данных
    post:
      tags: [События (Календарь)]
      summary: Создать новое событие
      description: Создание нового события с проверкой существования НКО и категорий
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventCreateRequest'
      responses:
        '201':
          description: Событие успешно создано
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventResponse'
        '404':
          description: НКО или категория не найдены
        '500':
          description: Ошибка базы данных

  /event/{eventId}:
    get:
      tags: [Публичные данные]
      summary: Получить детальную информацию о событии по ID
      parameters:
        - name: eventId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Детальная информация о событии
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventResponse'
        '404':
          description: Событие не найдено
        '500':
          description: Ошибка базы данных
    delete:
      tags: [События (Календарь)]
      summary: Удалить событие по ID
      description: Удаление события и всех связанных с ним данных (категории)
      parameters:
        - name: eventId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Событие успешно удалено
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Событие с ID 1 успешно удалено"
        '404':
          description: Событие не найдено
        '500':
          description: Ошибка базы данных

  /news:
    get:
      tags: [Публичные данные]
      summary: Получить ленту новостей
      parameters:
        - name: city_id
          in: query
          schema:
            type: integer
          description: ID города для фильтрации (если не указан, возвращаются общие новости)
      responses:
        '200':
          description: Список новостей
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/News'

  /knowledge-base:
    get:
      tags: [Публичные данные]
      summary: Получить список материалов из базы знаний
      parameters:
        - name: category
          in: query
          schema:
            type: string
          description: Категория для фильтрации
      responses:
        '200':
          description: Список материалов
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/KnowledgeBaseMaterial'

  # ===============================================================
  # НКО (управление) - дополнительные эндпоинты
  # ===============================================================
  /nko/{nkoId}:
    put:
      tags: [НКО (Некоммерческие организации)]
      summary: Обновить информацию о своем НКО
      description: Доступно только владельцу НКО или администратору.
      security:
        - BearerAuth: []
      parameters:
        - name: nkoId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NKOCreateRequest'
      responses:
        '200':
          description: НКО успешно обновлено
        '403':
          description: Доступ запрещен
        '404':
          description: НКО не найдено

  # ===============================================================
  # События (управление)
  # ===============================================================
  /events:
    post:
      tags: [События (Календарь)]
      summary: Добавить новое событие (отправка на модерацию)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventInput'
      responses:
        '202':
          description: Событие добавлено и отправлено на модерацию
        '401':
          description: Пользователь не авторизован

  # ===============================================================
  # Эндпоинты для администрирования (упрощенные)
  # ===============================================================
  /admin/nko/pending:
    get:
      tags: [Администрирование]
      summary: Получить список НКО, ожидающих модерации
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Список НКО на модерации
        '403':
          description: Доступ запрещен (только для администраторов)

  /admin/nko/{nkoId}/approve:
    post:
      tags: [Администрирование]
      summary: Одобрить регистрацию НКО
      security:
        - BearerAuth: []
      parameters:
        - name: nkoId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: НКО одобрено
        '403':
          description: Доступ запрещен

  /admin/news:
    post:
      tags: [Администрирование, Новости]
      summary: Добавить новость
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewsInput'
      responses:
        '201':
          description: Новость создана
        '403':
          description: Доступ запрещен

  /admin/knowledge-base:
    post:
      tags: [Администрирование, База знаний]
      summary: Добавить материал в базу знаний
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/KnowledgeBaseMaterialInput'
      responses:
        '201':
          description: Материал добавлен
        '403':
          description: Доступ запрещен

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    NKOFilterRequest:
      type: object
      required:
        - jwt_token
      properties:
        jwt_token:
          type: string
          description: JWT токен пользователя
        city:
          type: string
          nullable: true
          description: Название города для фильтрации
          example: "Москва"
        favorite:
          type: boolean
          nullable: true
          description: Фильтр по избранным НКО
        category:
          type: array
          items:
            type: string
          nullable: true
          description: Список категорий для фильтрации
          example: ["Помощь детям", "Образование"]
        regex:
          type: string
          nullable: true
          description: Регулярное выражение для поиска в названии и описании
          example: "инициативы"

    NKOCreateRequest:
      type: object
      required:
        - name
        - address
        - city
        - latitude
        - longitude
        - categories
      properties:
        name:
          type: string
          description: Название НКО
          example: "Благотворительный фонд «Подари жизнь»"
        description:
          type: string
          nullable: true
          description: Описание деятельности НКО
          example: "Помощь детям с онкологическими заболеваниями"
        logo:
          type: string
          nullable: true
          description: URL логотипа НКО
          example: "https://podari-zhizn.ru/logo.png"
        address:
          type: string
          description: Адрес НКО
          example: "г. Москва, ул. Доватора, д. 13"
        city:
          type: string
          description: Название города
          example: "Москва"
        latitude:
          type: number
          format: float
          description: Широта координат
          example: 55.7522
        longitude:
          type: number
          format: float
          description: Долгота координат
          example: 37.5665
        meta:
          type: object
          nullable: true
          description: Дополнительные метаданные (JSONB)
          example: {"url": "https://podari-zhizn.ru", "phone": "+7 (495) 123-45-67"}
        categories:
          type: array
          items:
            type: string
          description: Список названий категорий НКО
          example: ["Помощь детям", "Медицинская помощь"]

    NKOResponse:
      type: object
      properties:
        id:
          type: integer
          description: ID НКО
          example: 1
        name:
          type: string
          description: Название НКО
          example: "Благотворительный фонд «Подари жизнь»"
        description:
          type: string
          nullable: true
          description: Описание деятельности НКО
          example: "Помощь детям с онкологическими заболеваниями"
        logo:
          type: string
          nullable: true
          description: URL логотипа НКО
          example: "https://podari-zhizn.ru/logo.png"
        address:
          type: string
          description: Адрес НКО
          example: "г. Москва, ул. Доватора, д. 13"
        city:
          type: string
          nullable: true
          description: Название города
          example: "Москва"
        latitude:
          type: number
          format: float
          description: Широта координат
          example: 55.7522
        longitude:
          type: number
          format: float
          description: Долгота координат
          example: 37.5665
        meta:
          type: object
          nullable: true
          description: Дополнительные метаданные (JSONB)
          example: {"url": "https://podari-zhizn.ru"}
        created_at:
          type: string
          format: date-time
          nullable: true
          description: Дата создания записи
          example: "2024-01-20T12:00:00+03:00"
        categories:
          type: array
          items:
            type: string
          description: Список категорий НКО
          example: ["Помощь детям", "Медицинская помощь"]

    Event:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
          example: "Субботник в городском парке"
        description:
          type: string
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time
        city_id:
          type: integer
        address:
          type: string
        organizer_nko_id:
          type: integer
          description: ID НКО-организатора
        status:
          type: string
          enum: [approved, pending_moderation, rejected]
          example: "approved"

    EventInput:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time
        city_id:
          type: integer
        address:
          type: string
    EventFilterRequest:
      type: object
      required:
        - jwt_token
      properties:
        jwt_token:
          type: string
          description: JWT токен пользователя
        nko_id:
          type: array
          items:
            type: integer
          nullable: true
          description: Список ID НКО для фильтрации
          example: [1, 2]
        favorite:
          type: boolean
          nullable: true
          description: Фильтр по избранным событиям (заглушка)
        category:
          type: array
          items:
            type: string
          nullable: true
          description: Список категорий для фильтрации
          example: ["Спорт", "Культура"]
        regex:
          type: string
          nullable: true
          description: Регулярное выражение для поиска в названии и описании
          example: "концерт"
        time_from:
          type: string
          format: date-time
          nullable: true
          description: Фильтр по времени начала события
          example: "2024-01-01T00:00:00"
        time_to:
          type: string
          format: date-time
          nullable: true
          description: Фильтр по времени окончания события
          example: "2024-12-31T23:59:59"

    EventCreateRequest:
      type: object
      required:
        - nko_id
        - name
        - created_by
        - state
        - categories
      properties:
        nko_id:
          type: integer
          description: ID НКО-организатора
          example: 1
        name:
          type: string
          description: Название события
          example: "Благотворительный концерт"
        description:
          type: string
          nullable: true
          description: Описание события
          example: "Концерт в поддержку детей"
        address:
          type: string
          nullable: true
          description: Адрес проведения события
          example: "г. Москва, ул. Тверская, д. 1"
        picture:
          type: string
          nullable: true
          description: URL изображения события
          example: "https://example.com/event.jpg"
        latitude:
          type: number
          format: float
          nullable: true
          description: Широта координат
          example: 55.7558
        longitude:
          type: number
          format: float
          nullable: true
          description: Долгота координат
          example: 37.6173
        starts_at:
          type: string
          format: date-time
          nullable: true
          description: Время начала события
          example: "2024-12-01T10:00:00"
        finish_at:
          type: string
          format: date-time
          nullable: true
          description: Время окончания события
          example: "2024-12-01T18:00:00"
        created_by:
          type: integer
          description: ID пользователя-создателя
          example: 1
        state:
          type: string
          description: Статус события
          enum: [draft, approved, rejected, review]
          example: "draft"
        meta:
          type: string
          nullable: true
          description: Дополнительные метаданные
          example: "{}"
        categories:
          type: array
          items:
            type: string
          description: Список названий категорий события
          example: ["Спорт", "Культура"]

    EventResponse:
      type: object
      properties:
        id:
          type: integer
          description: ID события
          example: 1
        nko_id:
          type: integer
          description: ID НКО-организатора
          example: 1
        nko_name:
          type: string
          nullable: true
          description: Название НКО-организатора
          example: "Благотворительный фонд"
        name:
          type: string
          description: Название события
          example: "Благотворительный концерт"
        description:
          type: string
          nullable: true
          description: Описание события
          example: "Концерт в поддержку детей"
        address:
          type: string
          nullable: true
          description: Адрес проведения события
          example: "г. Москва, ул. Тверская, д. 1"
        picture:
          type: string
          nullable: true
          description: URL изображения события
          example: "https://example.com/event.jpg"
        latitude:
          type: number
          format: float
          nullable: true
          description: Широта координат
          example: 55.7558
        longitude:
          type: number
          format: float
          nullable: true
          description: Долгота координат
          example: 37.6173
        starts_at:
          type: string
          format: date-time
          nullable: true
          description: Время начала события
          example: "2024-12-01T10:00:00+03:00"
        finish_at:
          type: string
          format: date-time
          nullable: true
          description: Время окончания события
          example: "2024-12-01T18:00:00+03:00"
        created_by:
          type: integer
          description: ID пользователя-создателя
          example: 1
        approved_by:
          type: integer
          nullable: true
          description: ID модератора, одобрившего событие
          example: 2
        state:
          type: string
          description: Статус события
          enum: [draft, approved, rejected, review]
          example: "approved"
        meta:
          type: string
          nullable: true
          description: Дополнительные метаданные
          example: "{}"
        created_at:
          type: string
          format: date-time
          nullable: true
          description: Дата создания записи
          example: "2024-01-20T12:00:00+03:00"
        categories:
          type: array
          items:
            type: string
          description: Список категорий события
          example: ["Спорт", "Культура"]


    News:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        content:
          type: string
        image_url:
          type: string
          format: uri
        publication_date:
          type: string
          format: date-time
        city_id:
          type: integer
          nullable: true
          description: "null для общих новостей"

    NewsInput:
      type: object
      properties:
        title:
          type: string
        content:
          type: string
        image_url:
          type: string
          format: uri
        city_id:
          type: integer
          nullable: true

    KnowledgeBaseMaterial:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
          example: "Как организовать мероприятие"
        description:
          type: string
        category:
          type: string
        file_type:
          type: string
          enum: [pdf, video, link, document]
        url:
          type: string
          format: uri
          example: "https://example.com/guide.pdf"

    KnowledgeBaseMaterialInput:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        category:
          type: string
        file_type:
          type: string
          enum: [pdf, video, link, document]
        url:
          type: string
          format: uri

    City:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: "Ангарск, Иркутская область"

    UserProfile:
      type: object
      properties:
        id:
          type: integer
        email:
          type: string
          format: email
        name:
          type: string
        role:
          type: string
          enum: [user, admin]
        managed_nko_id:
          type: integer
          nullable: true
          description: "ID НКО, которым управляет пользователь"
        favorites:
          type: array
          items:
            type: object
            properties:
              item_type:
                type: string
                enum: [news, event, material]
              item_id:
                type: integer
                
    UserProfileUpdate:
      type: object
      properties:
        name:
          type: string
        email:
          type: string
          format: email

